---
title: "LASSO cross validation"
output: html_notebook
---

En esta etapa es importante empezar mostrando cuales de las variables se incluyen en el análisis para tener claridad. En estas simulaciones incluyo las variables "CD4_S24", "CD4porcentajeS24", "CocCD4_CD8_S0" y "CD8porcentajeS24" siguiendo la sugerencia de Enrique. Estas variables tienen coeficientes positivos usando lasso. En el siguiente output se muestran dichas variables.

```{r}
library(glmnet)
library(caret)
library(dplyr)
library(reshape2)

## preprocessing raw data
data <- read.csv("~/scripts/vihCohort/data/TablaLPS_IL18_20180217.csv")


## drop categorical data
data <- data[,sapply(data, is.numeric)]
## list of removed variables
drop <- c("Expediente",
          "IRIS",
          "DeltaCD4_W52",
          "Numero_consecutivo",
          "CD8porcentajeS24",
          "DeltaCD4W52atleast150",
          "CD4_S52",
          "CD4TCabove200_W052",
          "CD4TCabove350_W052",
          "Hepatitis_basal_activa")
input <- data[,!(colnames(data)%in%drop)]

## input definition
input <- as.matrix(input)

## output definition
output <- data$DeltaCD4_W52

## variables included in the analysis
colnames(input)
```

Para tratar de clarificar el análisis y pensando en figuras para el paper. Incluyo la siguiente figura que resume la implementación del análisis. 

![](../figures/VIHCohortAnalysis.jpg)



## Lambda optimization

As a first step Lambda is optimized using the whole data set to avoid bias.

```{r}
## lasso Lambda optimization

set.seed(33)

## model parameters
nfold.coeff <- 5

## performing lasso
lasso <- cv.glmnet(x = input,
                   y = output)

## storing optimal lambda
lambda.opt <- lasso$lambda.1se

plot(lasso)
```

En el siguiente código se muestra la validación cruzada usando 80%/20% (train/test). Aquí hay dos cosas importantes. Los coeficientes varian mucho de una simulación a otra

```{r}
## lasso cross validation

## vector to store coeficients and MSE for trainning and test
res <- matrix(0,0, length(coef(lasso)))
colnames(res) <- rownames(coef(lasso))
MSE.tr <- numeric(0)
MSE.te <- numeric(0)
ratio <- numeric(0)

## lasso iterations
for (p in seq(from=0.8,to = 0.95,by = 0.05)) {
        for (i in 1:100) {
                ## create partition
                inTrain <- createDataPartition(output, p = p, list = FALSE)
                Train   <- input[ inTrain, ] 
                Test <- input[-inTrain,]
                ## perform lasso
                lasso   <- cv.glmnet(x=Train, y=output[inTrain])
                ## obtain coefficients
                lasso.coef <- coef(lasso)
                lasso.coef <- as.vector(lasso.coef)
                res <- rbind(res,lasso.coef)
                ## obtain mse
                predicted.tr <- predict(lasso, newx = input[inTrain,], s=lambda.opt)
                predicted.te <- predict(lasso, newx = input[-inTrain,], s=lambda.opt)
                MSE.tr <- c(MSE.tr,mean((predicted.tr-output[inTrain])^2))
                MSE.te <- c(MSE.te,mean((predicted.te-output[-inTrain])^2))
                ratio <- c(ratio,p)
        }
}

## transform result matrix to dataframe and add mse column values
res.df <- as.data.frame(res)
res.df <- mutate(res.df, MSE.tr=MSE.tr)
res.df <- mutate(res.df, MSE.te=MSE.te)
res.df <- mutate(res.df, ratio=as.factor(ratio))

mse_train <- aggregate(MSE.tr~as.factor(ratio),res.df,mean)
mse_test <- aggregate(MSE.te~as.factor(ratio),res.df,mean)
sd_train <- aggregate(MSE.tr~as.factor(ratio),res.df,sd)
sd_test <- aggregate(MSE.te~as.factor(ratio),res.df,sd)


plot(as.numeric(paste(mse_test[,1])),mse_test[,2],
     col="green", pch=20, lwd=3, type = "l",ylim = c(-100,27000),
     xlab = "train/test", ylab = "MSE", main = "MSE vs train size")
points(as.numeric(paste(mse_test[,1])),mse_test[,2],
     col="green", pch=20,cex=1.5)
arrows(as.numeric(paste(mse_test[,1])),mse_test[,2]-sd_test[,2],
         as.numeric(paste(mse_test[,1])),mse_test[,2]+sd_test[,2],
       code = 3,angle = 90,length = 0.05,lwd=1.5)
par(new=TRUE)
plot(as.numeric(paste(mse_train[,1])),mse_train[,2],
               col="red",pch=20,lwd=3,type="l",
     axes = FALSE, xlab = "", ylab = "")
points(as.numeric(paste(mse_train[,1])),mse_train[,2],
       col="red", pch=20,cex=1.5)
arrows(as.numeric(paste(mse_train[,1])),mse_train[,2]+sd_train[,2],
       as.numeric(paste(mse_train[,1])),mse_train[,2]-sd_train[,2],
       code = 3,angle = 90,length = 0.05,lwd=1.5)
axis(side=4)


mse_test[,2]
sd_test[,2]
```


```{r}
## plot MSE for train and test
mses <- select(res,MSE.tr,MSE.te)
mses <- melt(mses)
p <- ggplot(mses, aes(x=variable,y=log(value+1))) + geom_boxplot()
p <- p + xlab("train vs test") + ylab("MSE") 
plot(p)
```
