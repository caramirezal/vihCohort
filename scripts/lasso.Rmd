---
title: "LASSO cross validation"
output: html_notebook
---

En esta etapa es importante empezar mostrando cuales de las variables se incluyen en el an치lisis para tener claridad. En estas simulaciones incluyo las variables "CD4_S24", "CD4porcentajeS24", "CocCD4_CD8_S0" y "CD8porcentajeS24" siguiendo la sugerencia de Enrique. Estas variables tienen coeficientes positivos usando lasso. En el siguiente output se muestran dichas variables.

```{r}
## preprocessing raw data
data <- read.csv("~/scripts/vihCohort/data/TablaLPS_IL18_20180217.csv")


## drop categorical data
data <- data[,sapply(data, is.numeric)]
## list of removed variables
drop <- c("Expediente",
          "IRIS",
          "DeltaCD4_W52",
          "Numero_consecutivo",
          "CD8porcentajeS24",
          "DeltaCD4W52atleast150",
          "CD4_S52",
          "CD4TCabove200_W052",
          "CD4TCabove350_W052",
          "Hepatitis_basal_activa")
input <- data[,!(colnames(data)%in%drop)]

## input definition
input <- as.matrix(input)

## output definition
output <- data$DeltaCD4_W52

## variables included in the analysis
colnames(input)
```

Para tratar de clarificar el an치lisis y pensando en figuras para el paper. Incluyo la siguiente figura que resume la implementaci칩n del an치lisis. 

![](../figures/VIHCohortAnalysis.jpg)



## Lambda optimization

As a first step Lambda is optimized using the whole data set to avoid bias.

```{r}
## lasso Lambda optimization
library(glmnet)

set.seed(33)

## model parameters
nfold.coeff <- 5

## performing lasso
lasso <- cv.glmnet(x = input,
                   y = output)

## storing optimal lambda
lambda.opt <- lasso$lambda.1se

plot(lasso)
```


```{r}
## lasso cross validation
library(caret)
library(dplyr)

## vector to store coeficients and MSE for trainning and test
res <- matrix(0,0, length(coef(lasso)))
colnames(res) <- rownames(coef(lasso))
MSE.tr <- numeric(0)
MSE.te <- numeric(0)

## lasso iterations
for (i in 1:100) {
        ## create partition
        inTrain <- createDataPartition(output, p = 0.8, list = FALSE)
        Train   <- input[ inTrain, ] 
        ## perform lasso
        lasso   <- cv.glmnet(x=Train, y=output[inTrain])
        ## obtain coefficients
        lasso.coef <- coef(lasso)
        lasso.coef <- as.vector(lasso.coef)
        res <- rbind(res,lasso.coef)
        ## obtain mse
        predicted.tr <- predict(lasso, newx = input[inTrain,], s=lasso$lambda.1se)
        predicted.te <- predict(lasso, newx = input[-inTrain,], s=lasso$lambda.1se)
        MSE.tr <- c(MSE.tr,mean((predicted.tr-output[inTrain])^2))
        MSE.te <- c(MSE.te,mean((predicted.te-output[-inTrain])^2))
}

res <- cbind(res,MSE.tr,MSE.te)

## mean and var calculation
cv <- data.frame(apply(res,2,mean),
                 apply(res,2,var))

names(cv) <- c("cv_mean","cv_var")
cv <- cv[order(-cv$cv_mean),]

indexes.sort <- order(res[,"MSE.tr"])
plot(1:nrow(res),log(res[indexes.sort,"MSE.tr"]),col="red")
points.default(1:nrow(res),log(res[indexes.sort,"MSE.te"]),col="blue")
```


